SUMMARY="Maria DB is an open-source relational database management system (RDBMS)"
DESCRIPTION="MariaDB server is a community developed fork of MySQL server. \
Started by core members of the original MySQL team, MariaDB actively works \
with outside developers to deliver the most featureful, stable, and sanely \
licensed open SQL server in the industry."
HOMEPAGE="https://www.mariadb.org/"
COPYRIGHT="2009 - 2025 MariaDB Foundation"
LICENSE="GNU GPL v2"
REVISION="1"
SOURCE_URI="https://github.com/MariaDB/server/archive/refs/tags/mariadb-11.7.2.tar.gz"
CHECKSUM_SHA256="63abb60682d7c62f0195e8aa85301775af11ef0b7e700775dd8f232068fbe448"
SOURCE_DIR="server-mariadb-$portVersion"
SOURCE_URI_2="https://github.com/mariadb-corporation/mariadb-connector-c/archive/refs/tags/v3.4.4.tar.gz"
CHECKSUM_SHA256_2="79a1c5a3de86e7daa0a456c502d60dc15debe105932ad6a0d25024908603f433"
SOURCE_URI_3="https://github.com/codership/wsrep-lib/archive/70cd967f5e249b53d6cce90e2e4198641c564381.tar.gz"
CHECKSUM_SHA256_3="bd44ee719f8fb303e8f90aaab105db836edc44cd8bb73004f20810248a0e6758"
SOURCE_URI_4="https://github.com/codership/wsrep-API/archive/refs/heads/master.tar.gz"
CHECKSUM_SHA256_4="ed0866ee46043b0e6f23cab0a7bcf11441add76ab9091e9e10c658ff0789841c"
SOURCE_URI_5="https://github.com/mariadb-corporation/libmarias3/archive/0d5babbe46f17147ed51efd1f05a0001017a2aad.tar.gz"
CHECKSUM_SHA256_5="6a190a80c210fc68b6590703ccbd5c68199c366786242c4b51b3a011cf7c10cd"
SOURCE_URI_6="https://github.com/mariadb-corporation/mariadb-columnstore-engine/archive/9763b126517c8efb716e767fd5ba4eb2b5b405fc.tar.gz"
CHECKSUM_SHA256_6="f5379d1df6163d25bcf1373bc1d55a4aa172f10df7a7d9e08b89dc076d340345"
PATCHES="mariadb-11.7.2.patchset"

ARCHITECTURES="?all !x86_gcc2 x86_64"
SECONDARY_ARCHITECTURES="!x86"

PROVIDES="
	mariadb = $portVersion
	cmd:mariadb$secondaryArchSuffix
	lib:libmariadb$secondaryArchSuffix
	"
REQUIRES="
	haiku
	lib:libboost_system$secondaryArchSuffix
#	lib:libcurl$secondaryArchSuffix
#	lib:libncurses$secondaryArchSuffix
	lib:libncursesw$secondaryArchSuffix
	lib:libpcre2_8$secondaryArchSuffix
	lib:libsnappy$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

PROVIDES_devel="
	mariadb${secondaryArchSuffix}_devel = $portVersion
	devel:libmariadb$secondaryArchSuffix
	devel:libmariadbclient$secondaryArchSuffix
	devel:libmysqlclient$secondaryArchSuffix
	devel:libmysqlclient_r$secondaryArchSuffix
	devel:libmysqlservices$secondaryArchSuffix
	"
REQUIRES_devel="
	mariadb$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libboost_system$secondaryArchSuffix >= 1.83.0
#	devel:libcurl$secondaryArchSuffix
	devel:libmsgpackc$secondaryArchSuffix
	devel:libncurses$secondaryArchSuffix
	devel:libpcre2_8$secondaryArchSuffix
	devel:libsnappy$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	devel:libzmq$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:bison
	cmd:cmake
	cmd:g++$secondaryArchSuffix
	cmd:make
	cmd:ninja
	cmd:pkg_config$secondaryArchSuffix
	cmd:python3
	cmd:which
	"

BUILD()
{
	# required sources
	cp -r $sourceDir2/mariadb-connector-c-3.4.4/* $sourceDir/libmariadb/
	cp -r $sourceDir3/wsrep-lib-70cd967f5e249b53d6cce90e2e4198641c564381/* $sourceDir/wsrep-lib
	cp -r $sourceDir4/wsrep-API-master/* $sourceDir/wsrep-lib/wsrep-API/v26

	# additional sources for libmarias3 / columnstore
	cp -r $sourceDir5/libmarias3-0d5babbe46f17147ed51efd1f05a0001017a2aad/* $sourceDir/storage/maria/libmarias3
	cp -r $sourceDir6/mariadb-columnstore-engine-9763b126517c8efb716e767fd5ba4eb2b5b405fc/* $sourceDir/storage/columnstore/columnstore

	# mariadbd binary is with debug info (even if release mode is indicated)
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=Release \
		-DWITHOUT_AIO=ON \
		-DPLUGIN_TOKUDB=NO \
		-DWITH_SYSTEMD=no \
		-DPLUGIN_CONNECT=NO \
		-DWITH_SSL=system \
		-DCMAKE_EXE_LINKER_FLAGS="-lnetwork" \
		-DCMAKE_SHARED_LINKER_FLAGS="-lnetwork" \
		-DWITHOUT_ROCKSDB=ON \
		-DWITH_UNIT_TESTS=NO \
		-DCMAKE_INSTALL_PREFIX=$appsDir/MariaDB

	cmake --build build $jobArgs
}


INSTALL()
{
	cmake --install build --prefix $appsDir/MariaDB

	# mariadb data
	mkdir -p /boot/home/config/var/mariadb/data

	# mariadb settings : put a default config file
	mkdir -p $settingsDir/mariadb

	# patch script "bin/mariadb-secure-installation"
	sed -i 's/config=".my.cnf.$$"/config="\/boot\/home\/config\/settings\/mariadb\/.my.cnf.$$"/' $appsDir/MariaDB/bin/mariadb-secure-installation
	sed -i 's/command=".mysql.$$"/command="\/boot\/home\/config\/settings\/mariadb\/.mysql.$$"/' $appsDir/MariaDB/bin/mariadb-secure-installation
	sed -i 's/output=".my.output.$$"/output="\/boot\/home\/config\/settings\/mariadb\/.my.output.$$"/' $appsDir/MariaDB/bin/mariadb-secure-installation

	# first installation script or README during installation procedure

	prepareInstalledDevelLibs \
		libmariadb \
		libmariadbclient \
		libmysqlclient \
		libmysqlclient_r \
		libmysqlservices
	fixPkgconfig

	packageEntries devel \
		$developDir

	# launch_daemon setup
	#sed \
	#	-e "s|@APP@|mariadbd|" \
	#	-e "s|@BIN@|"$appsDir"\/MariaDB\/bin\/mariadbd --user=user --datadir=\/boot\/home\/config\/var/mariadb\/data\/|" \
	#	$portDir/additional-files/userlaunch.in > $dataDir/user_launch/mariadbd

}

